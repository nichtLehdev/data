name: Merge JSON from PRs

on:
  workflow_dispatch:

jobs:
  merge-json:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
      
      - name: Find relevant PRs
        id: find_prs
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const targetFile = 'custom-data/airlines.json';
            
            // Get all open PRs
            const { data: allPRs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              per_page: 100
            });
            
            console.log(`Found ${allPRs.length} open PRs, checking for ${targetFile} changes...`);
            
            const relevantPRs = [];
            
            for (const pr of allPRs) {
              try {
                // Get files changed in this PR
                const { data: files } = await github.rest.pulls.listFiles({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: pr.number,
                  per_page: 100
                });
                
                // Check if ONLY airlines.json was modified
                const hasAirlinesJson = files.some(f => f.filename === targetFile);
                const onlyAirlinesJson = files.every(f => f.filename === targetFile);
                
                if (hasAirlinesJson && onlyAirlinesJson) {
                  relevantPRs.push(pr.number);
                  console.log(`âœ“ PR #${pr.number}: Only ${targetFile} modified`);
                } else if (hasAirlinesJson) {
                  console.log(`âœ— PR #${pr.number}: ${targetFile} modified but also other files`);
                } else {
                  console.log(`âœ— PR #${pr.number}: Does not modify ${targetFile}`);
                }
              } catch (e) {
                console.log(`Error checking PR #${pr.number}: ${e.message}`);
              }
            }
            
            if (relevantPRs.length === 0) {
              core.setFailed('No open PRs found that only modify custom-data/airlines.json');
              return;
            }
            
            console.log(`\nFound ${relevantPRs.length} relevant PRs: ${relevantPRs.join(', ')}`);
            core.setOutput('pr_numbers', relevantPRs.join(','));
            
            return relevantPRs;
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Merge JSON files from PRs
        id: merge
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            
            const prNumbers = '${{ steps.find_prs.outputs.pr_numbers }}'.split(',').map(n => n.trim());
            const jsonPath = 'custom-data/airlines.json';
            
            // Read base JSON from main
            let baseData = [];
            try {
              const baseContent = fs.readFileSync(jsonPath, 'utf8');
              baseData = JSON.parse(baseContent);
              if (!Array.isArray(baseData)) {
                baseData = [baseData];
              }
            } catch (e) {
              console.log('No existing file on main or invalid JSON, starting fresh');
            }
            
            // Create a map to track objects by their ICAO code
            const icaoMap = new Map();
            const objectOrder = [];
            
            // Add base objects first (preserving order)
            for (const obj of baseData) {
              if (obj.icao) {
                icaoMap.set(obj.icao, obj);
                objectOrder.push(obj.icao);
              }
            }
            
            // Process PRs and collect new/updated objects
            const processedPRs = [];
            const newObjects = [];
            
            for (const prNum of prNumbers) {
              try {
                const prNumber = parseInt(prNum);
                
                // Get PR details
                const { data: pr } = await github.rest.pulls.get({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: prNumber
                });
                
                // Get file content from PR branch
                try {
                  const { data: fileData } = await github.rest.repos.getContent({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    path: jsonPath,
                    ref: pr.head.sha
                  });
                  
                  const content = Buffer.from(fileData.content, 'base64').toString('utf8');
                  let prData = JSON.parse(content);
                  
                  if (!Array.isArray(prData)) {
                    prData = [prData];
                  }
                  
                  // Check each object from the PR
                  for (const obj of prData) {
                    if (!obj.icao) {
                      console.log(`Skipping object without ICAO code in PR #${prNumber}`);
                      continue;
                    }
                    
                    if (icaoMap.has(obj.icao)) {
                      // Check if it's an exact duplicate
                      const existing = icaoMap.get(obj.icao);
                      if (JSON.stringify(existing) === JSON.stringify(obj)) {
                        console.log(`Duplicate object (${obj.icao}) in PR #${prNumber}, skipping`);
                        continue;
                      }
                      
                      // It's an update - replace the existing object
                      icaoMap.set(obj.icao, obj);
                      console.log(`Updated airline ${obj.icao} from PR #${prNumber}`);
                    } else {
                      // New airline, add to the end
                      newObjects.push(obj);
                      console.log(`New airline ${obj.icao} from PR #${prNumber}`);
                    }
                  }
                  
                  processedPRs.push(prNumber);
                  console.log(`Processed PR #${prNumber}`);
                } catch (e) {
                  console.log(`Could not read file from PR #${prNumber}: ${e.message}`);
                }
              } catch (e) {
                console.log(`Error processing PR #${prNum}: ${e.message}`);
              }
            }
            
            if (processedPRs.length === 0) {
              core.setFailed('No PRs were successfully processed');
              return;
            }
            
            // Build final array: existing objects in order, then new objects
            const finalData = [];
            
            // Add existing/updated objects in original order
            for (const icao of objectOrder) {
              if (icaoMap.has(icao)) {
                finalData.push(icaoMap.get(icao));
              }
            }
            
            // Add new objects at the end
            for (const obj of newObjects) {
              finalData.push(obj);
            }
            
            // Write merged file
            fs.writeFileSync(jsonPath, JSON.stringify(finalData, null, 2) + '\n');
            
            // Set outputs
            core.setOutput('processed_prs', processedPRs.join(','));
            core.setOutput('object_count', finalData.length);
            
            return { processedPRs, objectCount: finalData.length };
      
      - name: Create Pull Request
        id: create_pr
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: 'chore: merge airlines.json from PRs ${{ steps.merge.outputs.processed_prs }}'
          branch: airlines-merge-${{ github.run_number }}
          delete-branch: true
          title: 'Merge airlines.json from PRs: ${{ steps.merge.outputs.processed_prs }}'
          body: |
            This PR merges airlines data from the following PRs:
            ${{ steps.merge.outputs.processed_prs }}
            
            - Total airline objects: ${{ steps.merge.outputs.object_count }}
            - Existing objects updated in place
            - New objects added to the end
            
            **Auto-detected PRs** that only modified `custom-data/airlines.json`
            
            Generated by workflow run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          labels: automated-merge
      
      - name: Label included PRs
        if: steps.create_pr.outputs.pull-request-number
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const processedPRs = '${{ steps.merge.outputs.processed_prs }}'.split(',');
            
            for (const prNum of processedPRs) {
              try {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: parseInt(prNum),
                  labels: ['included-in-merge']
                });
                
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: parseInt(prNum),
                  body: `This PR has been included in merge PR #${{ steps.create_pr.outputs.pull-request-number }}`
                });
              } catch (e) {
                console.log(`Could not label PR #${prNum}: ${e.message}`);
              }
            }
      
      - name: Summary
        run: |
          echo "## Merge Complete! ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **PRs processed:** ${{ steps.merge.outputs.processed_prs }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Total objects:** ${{ steps.merge.outputs.object_count }}" >> $GITHUB_STEP_SUMMARY
          echo "- **New PR:** #${{ steps.create_pr.outputs.pull-request-number }}" >> $GITHUB_STEP_SUMMARY