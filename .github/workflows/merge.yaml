name: Merge JSON from PRs

on:
  workflow_dispatch:
    inputs:
      sort_by_key:
        description: 'Object key to sort by'
        required: true
        default: 'icao'
        type: string

jobs:
  merge-json:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
      
      - name: Find relevant PRs
        id: find_prs
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const targetFile = 'custom-data/airlines.json';
            
            // Get all open PRs
            const { data: allPRs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              per_page: 100
            });
            
            console.log(`Found ${allPRs.length} open PRs, checking for ${targetFile} changes...`);
            
            const relevantPRs = [];
            
            for (const pr of allPRs) {
              try {
                // Get files changed in this PR
                const { data: files } = await github.rest.pulls.listFiles({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: pr.number,
                  per_page: 100
                });
                
                // Check if ONLY airlines.json was modified
                const hasAirlinesJson = files.some(f => f.filename === targetFile);
                const onlyAirlinesJson = files.every(f => f.filename === targetFile);
                
                if (hasAirlinesJson && onlyAirlinesJson) {
                  relevantPRs.push(pr.number);
                  console.log(`âœ“ PR #${pr.number}: Only ${targetFile} modified`);
                } else if (hasAirlinesJson) {
                  console.log(`âœ— PR #${pr.number}: ${targetFile} modified but also other files`);
                } else {
                  console.log(`âœ— PR #${pr.number}: Does not modify ${targetFile}`);
                }
              } catch (e) {
                console.log(`Error checking PR #${pr.number}: ${e.message}`);
              }
            }
            
            if (relevantPRs.length === 0) {
              core.setFailed('No open PRs found that only modify custom-data/airlines.json');
              return;
            }
            
            console.log(`\nFound ${relevantPRs.length} relevant PRs: ${relevantPRs.join(', ')}`);
            core.setOutput('pr_numbers', relevantPRs.join(','));
            
            return relevantPRs;
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Merge JSON files from PRs
        id: merge
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const path = require('path');
            
            const prNumbers = '${{ steps.find_prs.outputs.pr_numbers }}'.split(',').map(n => n.trim());
            const jsonPath = 'custom-data/airlines.json';
            const sortKey = '${{ inputs.sort_by_key }}';
            
            // Read base JSON from main
            let baseData = [];
            try {
              const baseContent = fs.readFileSync(jsonPath, 'utf8');
              baseData = JSON.parse(baseContent);
              if (!Array.isArray(baseData)) {
                baseData = [baseData];
              }
            } catch (e) {
              console.log('No existing file on main or invalid JSON, starting fresh');
            }
            
            // Collect all objects from PRs
            const allObjects = [...baseData];
            const processedPRs = [];
            
            for (const prNum of prNumbers) {
              try {
                const prNumber = parseInt(prNum);
                
                // Get PR details
                const { data: pr } = await github.rest.pulls.get({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: prNumber
                });
                
                // Get file content from PR branch
                try {
                  const { data: fileData } = await github.rest.repos.getContent({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    path: jsonPath,
                    ref: pr.head.sha
                  });
                  
                  const content = Buffer.from(fileData.content, 'base64').toString('utf8');
                  let prData = JSON.parse(content);
                  
                  if (!Array.isArray(prData)) {
                    prData = [prData];
                  }
                  
                  allObjects.push(...prData);
                  processedPRs.push(prNumber);
                  console.log(`Added data from PR #${prNumber}`);
                } catch (e) {
                  console.log(`Could not read file from PR #${prNumber}: ${e.message}`);
                }
              } catch (e) {
                console.log(`Error processing PR #${prNum}: ${e.message}`);
              }
            }
            
            if (processedPRs.length === 0) {
              core.setFailed('No PRs were successfully processed');
              return;
            }
            
            // Remove duplicates based on JSON stringification
            const uniqueObjects = [];
            const seen = new Set();
            
            for (const obj of allObjects) {
              const key = JSON.stringify(obj);
              if (!seen.has(key)) {
                seen.add(key);
                uniqueObjects.push(obj);
              }
            }
            
            // Sort by specified key
            uniqueObjects.sort((a, b) => {
              const aVal = a[sortKey]?.toString() || '';
              const bVal = b[sortKey]?.toString() || '';
              return aVal.localeCompare(bVal);
            });
            
            // Write merged file
            fs.writeFileSync(jsonPath, JSON.stringify(uniqueObjects, null, 2) + '\n');
            
            // Set outputs
            core.setOutput('processed_prs', processedPRs.join(','));
            core.setOutput('object_count', uniqueObjects.length);
            
            return { processedPRs, objectCount: uniqueObjects.length };
      
      - name: Create Pull Request
        id: create_pr
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: 'chore: merge airlines.json from PRs ${{ steps.merge.outputs.processed_prs }}'
          branch: airlines-merge-${{ github.run_number }}
          delete-branch: true
          title: 'Merge airlines.json from PRs: ${{ steps.merge.outputs.processed_prs }}'
          body: |
            This PR merges airlines data from the following PRs:
            ${{ steps.merge.outputs.processed_prs }}
            
            - Total airline objects: ${{ steps.merge.outputs.object_count }}
            - Duplicates removed
            - Sorted by: `${{ inputs.sort_by_key }}`
            
            **Auto-detected PRs** that only modified `custom-data/airlines.json`
            
            Generated by workflow run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          labels: automated-merge
      
      - name: Label included PRs
        if: steps.create_pr.outputs.pull-request-number
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const processedPRs = '${{ steps.merge.outputs.processed_prs }}'.split(',');
            
            for (const prNum of processedPRs) {
              try {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: parseInt(prNum),
                  labels: ['included-in-merge']
                });
                
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: parseInt(prNum),
                  body: `âœ… This PR has been included in merge PR #${{ steps.create_pr.outputs.pull-request-number }}`
                });
              } catch (e) {
                console.log(`Could not label PR #${prNum}: ${e.message}`);
              }
            }
      
      - name: Summary
        run: |
          echo "## Merge Complete! ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **PRs processed:** ${{ steps.merge.outputs.processed_prs }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Total objects:** ${{ steps.merge.outputs.object_count }}" >> $GITHUB_STEP_SUMMARY
          echo "- **New PR:** #${{ steps.create_pr.outputs.pull-request-number }}" >> $GITHUB_STEP_SUMMARY