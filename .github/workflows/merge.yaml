name: Merge JSON from PRs

on:
  workflow_dispatch:

jobs:
  merge-json:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
      
      - name: Find relevant PRs
        id: find_prs
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const targetFile = 'custom-data/airlines.json';
            
            // Get all open PRs
            const { data: allPRs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              per_page: 100
            });
            
            console.log(`Found ${allPRs.length} open PRs, checking for ${targetFile} changes...`);
            
            const relevantPRs = [];
            
            for (const pr of allPRs) {
              try {
                // Get files changed in this PR
                const { data: files } = await github.rest.pulls.listFiles({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: pr.number,
                  per_page: 100
                });
                
                // Check if ONLY airlines.json was modified
                const hasAirlinesJson = files.some(f => f.filename === targetFile);
                const onlyAirlinesJson = files.every(f => f.filename === targetFile);
                
                if (hasAirlinesJson && onlyAirlinesJson) {
                  relevantPRs.push(pr.number);
                  console.log(`✓ PR #${pr.number}: Only ${targetFile} modified`);
                } else if (hasAirlinesJson) {
                  console.log(`✗ PR #${pr.number}: ${targetFile} modified but also other files`);
                } else {
                  console.log(`✗ PR #${pr.number}: Does not modify ${targetFile}`);
                }
              } catch (e) {
                console.log(`Error checking PR #${pr.number}: ${e.message}`);
              }
            }
            
            if (relevantPRs.length === 0) {
              core.setFailed('No open PRs found that only modify custom-data/airlines.json');
              return;
            }
            
            console.log(`\nFound ${relevantPRs.length} relevant PRs: ${relevantPRs.join(', ')}`);
            core.setOutput('pr_numbers', relevantPRs.join(','));
            
            return relevantPRs;
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Merge JSON files from PRs
        id: merge
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            
            const prNumbers = '${{ steps.find_prs.outputs.pr_numbers }}'.split(',').map(n => n.trim());
            const jsonPath = 'custom-data/airlines.json';
            
            // Read base JSON from main
            let baseData = [];
            try {
              const baseContent = fs.readFileSync(jsonPath, 'utf8');
              baseData = JSON.parse(baseContent);
              if (!Array.isArray(baseData)) {
                baseData = [baseData];
              }
            } catch (e) {
              console.log('No existing file on main or invalid JSON, starting fresh');
            }
            
            // Create a map to track objects by ICAO+callsign combination
            const airlineMap = new Map();
            const objectOrder = [];
            
            // Add base objects first (preserving order)
            for (const obj of baseData) {
              if (obj.icao && obj.callsign) {
                const key = `${obj.icao}|${obj.callsign}`;
                airlineMap.set(key, obj);
                objectOrder.push(key);
              }
            }
            
            // Process PRs and collect new/updated objects
            const processedPRs = [];
            const manualPRs = [];
            const newObjects = [];
            
            for (const prNum of prNumbers) {
              try {
                const prNumber = parseInt(prNum);
                
                // Get PR details
                const { data: pr } = await github.rest.pulls.get({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: prNumber
                });
                
                // Get file content from PR branch
                try {
                  const { data: fileData } = await github.rest.repos.getContent({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    path: jsonPath,
                    ref: pr.head.sha
                  });
                  
                  const content = Buffer.from(fileData.content, 'base64').toString('utf8');
                  let prData = JSON.parse(content);
                  
                  if (!Array.isArray(prData)) {
                    prData = [prData];
                  }
                  
                  // Check each object from the PR
                  for (const obj of prData) {
                    if (!obj.icao || !obj.callsign) {
                      console.log(`Skipping object without ICAO or callsign in PR #${prNumber}`);
                      continue;
                    }
                    
                    const key = `${obj.icao}|${obj.callsign}`;
                    
                    // Check for exact match (ICAO + callsign)
                    if (airlineMap.has(key)) {
                      const existing = airlineMap.get(key);
                      if (JSON.stringify(existing) === JSON.stringify(obj)) {
                        console.log(`Duplicate airline (${obj.icao}/${obj.callsign}) in PR #${prNumber}, skipping`);
                        continue;
                      }
                      
                      // It's an update - replace the existing object
                      airlineMap.set(key, obj);
                      console.log(`Updated airline ${obj.icao}/${obj.callsign} from PR #${prNumber}`);
                      continue;
                    }
                    
                    // Check if there's an airline with same ICAO but different callsign
                    // This could be either:
                    // 1. A new airline with same ICAO (OK to add)
                    // 2. A callsign change (ambiguous - needs manual review)
                    let hasSameIcao = false;
                    for (const [existingKey, existingObj] of airlineMap.entries()) {
                      if (existingObj.icao === obj.icao) {
                        hasSameIcao = true;
                        break;
                      }
                    }
                    
                    if (hasSameIcao) {
                      // Ambiguous case - could be callsign change or new airline
                      console.log(`Ambiguous change for ${obj.icao} in PR #${prNumber} - needs manual review`);
                      if (!manualPRs.includes(prNumber)) {
                        manualPRs.push(prNumber);
                      }
                      continue;
                    }
                    
                    // Completely new airline (new ICAO+callsign combination)
                    newObjects.push(obj);
                    console.log(`New airline ${obj.icao}/${obj.callsign} from PR #${prNumber}`);
                  }
                  
                  processedPRs.push(prNumber);
                  console.log(`Processed PR #${prNumber}`);
                } catch (e) {
                  console.log(`Could not read file from PR #${prNumber}: ${e.message}`);
                }
              } catch (e) {
                console.log(`Error processing PR #${prNum}: ${e.message}`);
              }
            }
            
            if (processedPRs.length === 0) {
              core.setFailed('No PRs were successfully processed');
              return;
            }
            
            // Build final array: existing objects in order, then new objects
            const finalData = [];
            
            // Add existing/updated objects in original order
            for (const key of objectOrder) {
              if (airlineMap.has(key)) {
                finalData.push(airlineMap.get(key));
              }
            }
            
            // Add new objects at the end
            for (const obj of newObjects) {
              finalData.push(obj);
            }
            
            // Write merged file
            fs.writeFileSync(jsonPath, JSON.stringify(finalData, null, 2) + '\n');
            
            // Set outputs
            core.setOutput('processed_prs', processedPRs.filter(pr => !manualPRs.includes(pr)).join(','));
            core.setOutput('manual_prs', manualPRs.join(','));
            core.setOutput('object_count', finalData.length);
            
            return { 
              processedPRs: processedPRs.filter(pr => !manualPRs.includes(pr)), 
              manualPRs,
              objectCount: finalData.length 
            };
      
      - name: Create Pull Request
        id: create_pr
        if: steps.merge.outputs.processed_prs != ''
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: 'chore: merge airlines.json from PRs ${{ steps.merge.outputs.processed_prs }}'
          branch: airlines-merge-${{ github.run_number }}
          delete-branch: true
          title: 'Merge airlines.json from PRs: ${{ steps.merge.outputs.processed_prs }}'
          body: |
            This PR merges airlines data from the following PRs:
            ${{ steps.merge.outputs.processed_prs }}
            
            - Total airline objects: ${{ steps.merge.outputs.object_count }}
            - Existing objects updated in place
            - New objects added to the end
            
            **Auto-detected PRs** that only modified `custom-data/airlines.json`
            
            ${{ steps.merge.outputs.manual_prs != '' && format('**Manual review needed for PRs:** {0}', steps.merge.outputs.manual_prs) || '' }}
            
            Generated by workflow run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          labels: automated-merge
      
      - name: Label included PRs
        if: steps.create_pr.outputs.pull-request-number && steps.merge.outputs.processed_prs != ''
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const processedPRs = '${{ steps.merge.outputs.processed_prs }}'.split(',').filter(p => p);
            
            for (const prNum of processedPRs) {
              try {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: parseInt(prNum),
                  labels: ['included-in-merge']
                });
                
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: parseInt(prNum),
                  body: `This PR has been included in merge PR #${{ steps.create_pr.outputs.pull-request-number }}`
                });
              } catch (e) {
                console.log(`Could not label PR #${prNum}: ${e.message}`);
              }
            }
      
      - name: Label manual review PRs
        if: steps.merge.outputs.manual_prs != ''
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const manualPRs = '${{ steps.merge.outputs.manual_prs }}'.split(',').filter(p => p);
            
            for (const prNum of manualPRs) {
              try {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: parseInt(prNum),
                  labels: ['needs-manual-merge']
                });
                
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: parseInt(prNum),
                  body: `This PR contains ambiguous changes (same ICAO with different callsign) and requires manual review. This could be either:\n- A callsign change for an existing airline\n- A new airline that shares the same ICAO code\n\nPlease merge this PR manually.`
                });
              } catch (e) {
                console.log(`Could not label PR #${prNum}: ${e.message}`);
              }
            }
      
      - name: Summary
        run: |
          echo "## Merge Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **PRs processed:** ${{ steps.merge.outputs.processed_prs }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Total objects:** ${{ steps.merge.outputs.object_count }}" >> $GITHUB_STEP_SUMMARY
          if [ -n "${{ steps.create_pr.outputs.pull-request-number }}" ]; then
            echo "- **New PR:** #${{ steps.create_pr.outputs.pull-request-number }}" >> $GITHUB_STEP_SUMMARY
          fi
          if [ -n "${{ steps.merge.outputs.manual_prs }}" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "⚠️ **Manual review needed for PRs:** ${{ steps.merge.outputs.manual_prs }}" >> $GITHUB_STEP_SUMMARY
          fi